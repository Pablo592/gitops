{{- $namespace := .Values.group | replace "." "" -}}
{{- $name := .Values.project -}}

apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name:  {{ $name }}-auth
  namespace: {{ $namespace }}
spec:
  method: kubernetes
  mount: {{ .Values.cluster }}
{{- if eq (.Values.cluster) "prod" }}
  kubernetes:
    role: {{ $namespace }}
{{- else }}
  kubernetes:
    role: {{ .Values.cluster }}
{{- end }}
    serviceAccount: default
    audiences:
      - vault

---

{{- $allPaths := list -}}

{{- range .Values.secrets }}
  {{- $allPaths = append $allPaths .path }}
{{- end }}

{{- range .Values.fileFromSecret.files }}
  {{- $allPaths = append $allPaths .path }}
{{- end }}

{{- range .Values.environmentFromSecret.secrets }}
  {{- $allPaths = append $allPaths .path }}
{{- end }}

{{- $uniquePaths := uniq $allPaths }}


{{- range $p := $uniquePaths }}

  {{- $ctx := dict "path" $p "name" $name "namespace" $namespace -}}
  {{- include "base_webserver.path-secret" $ctx }}
  
---
{{- end }}



